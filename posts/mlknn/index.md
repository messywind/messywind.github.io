# KNN


## 概述

简单来讲，就是给定一个训练集，然后拿到一个新的输入数据，在训练集中找到与该输入的 $k$ 个数据，这 $k$ 个数据数量多的某个类，就是该新数据的类别。这个算法称为 $k$ 近邻 ($\text{K-Nearest Neighbors}$)

## 模型

### 距离

输入和训练集的距离该如何度量，一般来说有以下几种度量方式：

假设数据集特征向量 $x_i \in \textbf{R}^n$，$x_i = \left(x_i^{(1)}, x_i^{(2)},\cdots,x_i^{(n)}\right) ^ \top$

#### 闵可夫斯基 (Minkowski) 距离 

$$
L_p(x_i,x_j) = \left( \sum_{l = 1} ^ {n} |x_i^{(l)} - x_j^{(l)}|^p \right) ^ {\frac{1}{p}}
$$

#### 欧氏距离

其实就是闵可夫斯基距离的 $p = 2$

$$
L_2(x_i,x_j) = \sqrt{ \sum_{l = 1} ^ {n} |x_i^{(l)} - x_j^{(l)}|^2 }
$$

#### 曼哈顿距离

其实就是闵可夫斯基距离的 $p = 1$

$$
L_2(x_i,x_j) = \sum_{l = 1} ^ {n} |x_i^{(l)} - x_j^{(l)}|
$$

显然的，不同距离的 k 近邻点是不同的。

### $k$ 的大小

- $k$ 过小：如果相邻点是噪声，会影响预测，过拟合。
- $k$ 过大：模型简化，欠拟合。

建议使用网格搜索，交叉验证，选取一个较小的 $k$ 值开始，不断增加 $k$ 值，然后计算方差。

### 分类决策规则

多数表决法。

对于每个类别 $c_j \in \\{ c_1,c_2,\cdots,c_m \\}$ 来说，假设 $k$ 个近邻点的领域集为 $N_k(x)$，那么输出为

$$
y = \argmax_{c_j} \sum_{x_i \in N_k(x)} [y_i = c_j]
$$

即出现次数最多的类别的类就是分类结果。

### KDTree (K-Dimension Tree)

如何找 $k$ 个近邻的点呢？可以考虑使用 KDTree 实现，没错这就是算竞中的 KDTree。

#### 建树

- 首先取第一维，找到该维所有点的中位数，选择这个点作为根节点，然后将小于该维的点归入左子树，其余的归入右子树 (相当于分割成两个超正方体)

- 维度增加 $1$ 并取模 $k$，继续对该维做步骤 $1$

- 如此递归下去，当只有一个点的时候返回该点。

举一个 $k = 2$ 的例子。

&lt;div align=center&gt;&lt;img src=&#34;/image/ML/kdt1.jpg&#34;&gt;&lt;/div&gt;

建出的树：

&lt;div align=center&gt;&lt;img src=&#34;/image/ML/kdt2.jpg&#34;&gt;&lt;/div&gt;

这样树的高度最多为 $\log n$

#### 插入

从根节点开始，在每一个节点处根据划分维度的坐标的相对大小决定往左还是往右走，直至到达某个叶子节点，然后将新点插入到该叶子节点下方即可。

#### 删除

删除某个节点时，需要首先对该节点下方子树上的所有节点打散并重新构建新的子树，然后用新子树的根节点替换被删除的节点，并释放被删除节点的内存。

#### 查询

首先看一下最近邻的查询方法。

- 从根节点出发，递归向下访问，如果目标点 $x$ 的当前维坐标小于访问点的坐标，则访问左子树，否则访问右子树，直到访问到叶节点为止。

- 假设该叶节点为最近点，以目标点 $x$ 为圆心，目标点 $x$ 到叶节点的距离为半径画一个超球。

- 递归向上回退，深度遍历每个树上节点，如果树上节点对应的点在超球内，则更新超球的半径，如果在超球外，直接剪枝。

- 最后超球上的那个点就是最近邻点。

那么 $k$ 近邻的方法就是将所有点放到一个优先队列里，优先队列里只存前 $k$ 近的点，超球半径就是目标点到最远点的距离，dfs 过程中依然要剪枝。

## 参考

https://zhuanlan.zhihu.com/p/529487972

https://oi-wiki.org/ds/kdt/

https://blog.csdn.net/weixin_39910711/article/details/114447104

https://blog.csdn.net/qq_42688495/article/details/124049811

统计学习方法(第2版)李航

---

> 作者: [凌乱之风](https://github.com/messywind)  
> URL: https://blog.messywind.top/posts/mlknn/  

